<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Reservation Dashboard</title>

<style>
  :root {
    --bg:#f6f8fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --primary:#2563eb; --primary-ink:#fff;
    --border:#e5e7eb; --shadow:0 6px 18px rgba(31,41,55,0.06);
    --head:#1d4ed8;
  }
  body { margin:0; background:var(--bg); font-family:ui-sans-serif,system-ui,Arial; color:var(--ink); }
  .wrap { max-width:1200px; margin:auto; padding:30px 16px; }

  header { display:flex; justify-content:space-between; align-items:center; }
  h1 { margin:0; }

  .toolbar { display:flex; gap:10px; }
  .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--border); cursor:pointer; }
  .btn.primary { background:var(--primary); color:white; border:none; }

  .filters, .table-availability {
    background:white; padding:14px; border-radius:14px; border:1px solid var(--border);
    margin-bottom:22px; box-shadow:var(--shadow);
  }

  .table-grid { display:grid; grid-template-columns: repeat(5,1fr); gap:10px; }
  .tcard {
    border:1px solid var(--border); padding:10px; border-radius:12px;
    cursor:pointer; display:flex; flex-direction:column;
  }

  .free { background:#ecfdf5; color:#166534; border-radius:20px; padding:3px 8px; }
  .occupied { background:#fee2e2; color:#b91c1c; border-radius:20px; padding:3px 8px; }

  table { width:100%; border-collapse:collapse; }
  thead th { background:var(--head); color:white; padding:12px; }
  tbody td { padding:12px; border-top:1px solid var(--border); }

  .dropdown-menu {
    position:absolute; right:0; top:22px; background:white; border-radius:8px;
    border:1px solid var(--border); display:none;
  }
  .dropdown-menu button { width:100%; border:none; padding:8px; background:white; cursor:pointer; }
  .dropdown-menu button:hover { background:#eef2ff; }

  .modal-backdrop {
    position:fixed; inset:0; background:#0008; display:none;
    justify-content:center; align-items:center; z-index:100;
  }
  .modal { background:white; width:600px; padding:16px; border-radius:16px; }
</style>
</head>

<body>
<div class="wrap">

<header>
  <h1>ü§ñ Reservations</h1>
  <div class="toolbar">
    <button class="btn primary" id="newBtn">+ New Reservation</button>
    <button class="btn" id="refreshBtn">Refresh</button>
  </div>
</header>

<!-- TABLE STATUS -->
<div class="table-availability">
  <h2>üü© Table Availability</h2>
  <div id="tableGrid" class="table-grid"></div>
</div>

<!-- TABLE -->
<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Date</th><th>Time</th><th>Customer</th><th>Contact</th>
  <th>Party</th><th>Table</th><th>Status</th><th>Actions</th>
</tr>
</thead>
<tbody id="tbody">

{% for r in reservations %}
<tr data-table="{{ r.table_number }}" data-status="{{ r.status }}">

  {% if r.datetime and "T" in r.datetime %}
    {% set dt = r.datetime.split("T") %}
    <td>{{ dt[0] }}</td>
    <td>{{ dt[1][:5] }}</td>
  {% else %}
    <td>-</td><td>-</td>
  {% endif %}

  <td>{{ r.customer_name }}</td>
  <td>{{ r.contact_phone or "-" }}</td>
  <td>{{ r.party_size }}</td>
  <td>{{ r.table_number or "-" }}</td>
  <td>{{ r.status }}</td>

  <td>
    <button onclick="openEdit({{ r.reservation_id }}, '{{ r.datetime }}', '{{ r.party_size }}', '{{ r.table_number }}', `{{ r.notes or '' }}`)">‚úèÔ∏è</button>
  </td>
</tr>
{% endfor %}

</tbody>
</table>
</div>
</div>

<!-- EDIT MODAL -->
<div class="modal-backdrop" id="editModal">
<div class="modal">
  <h3>Edit Reservation</h3>

  <label>Date & Time</label>
  <input id="dt" type="datetime-local">

  <label>Party Size</label>
  <input id="ps" type="number">

  <label>Table</label>
  <input id="table">

  <label>Notes</label>
  <textarea id="notes"></textarea>

  <button class="btn primary" id="saveBtn">Save</button>
  <button class="btn" onclick="closeEdit()">Cancel</button>
</div>
</div>

<script>
/* ‚úÖ OPEN EDIT MODAL */
let currentId = null;

function openEdit(id, dt, ps, table, notes) {
  currentId = id;

  document.getElementById("dt").value = dt.includes("T") ? dt.slice(0, 16) : "";
  document.getElementById("ps").value = ps;
  document.getElementById("table").value = table !== "null" ? table : "";
  document.getElementById("notes").value = notes;

  document.getElementById("editModal").style.display = "flex";
}

function closeEdit(){
  document.getElementById("editModal").style.display = "none";
}

/* ‚úÖ SAVE EDIT */
document.getElementById("saveBtn").onclick = async () => {
  const payload = {
    reservation_id: currentId,
    datetime: document.getElementById("dt").value + ":00",
    party_size: Number(document.getElementById("ps").value),
    table_number: document.getElementById("table").value,
    notes: document.getElementById("notes").value,
    status: "updated"
  };

  await fetch("/updateReservation", {
    method:"POST",
    headers:{ "Content-Type": "application/json" },
    body:JSON.stringify(payload)
  });

  closeEdit();
  location.reload();
};

/* TABLE GRID */
const TABLE_IDS=["T1","T2","T3","T4","T5","T6","T7","T8","T9","T10"];

function buildTableGrid(){
  const grid=document.getElementById("tableGrid");
  const rows=[...document.querySelectorAll("#tbody tr")];

  grid.innerHTML="";
  TABLE_IDS.forEach(id=>{
    const reserved = rows.some(r => r.dataset.table === id && r.dataset.status !== "cancelled");
    grid.innerHTML += `
      <div class="tcard">
        <b>${id}</b>
        <span class="${reserved ? 'occupied':'free'}">${reserved?'Occupied':'Free'}</span>
      </div>`;
  });
}
buildTableGrid();
</script>

</body>
</html>
